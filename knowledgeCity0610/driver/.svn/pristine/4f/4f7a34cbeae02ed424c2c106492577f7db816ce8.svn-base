#coding=utf-8
# ycat			2018-8-2	  create
# seerAgv的语义调用 
import sys,os 
import datetime
import setup
if __name__ == '__main__':
	setup.setCurPath(__file__)
import driver.seerAgv.agvApi as agvApi
import log

def checkLink(agvId):
	return agvApi.checkLink(agvId)

def cancelTask(agvId):
	agvApi.task(agvId,"robot_task_cancel_req",None)

#机器人启动后会有一定的初始化时间，通过 (1111) 可查询机器人的初始化状态 
#0 = FAILED(初始化失败), 1 = SUCCESS(初始化成功), 2 = INITING(正在初始化) 
def checkInit(agvId):
	data= agvApi.status(agvId,"robot_status_init_req",None)
	return data["init_status"]

#重定位,pos为(x,y,r)三元组 
def reloc(agvId,pos=None):
	if pos is None:
		agvApi.ctrl(agvId,"robot_control_reloc_req",{"home":True})
	else:
		agvApi.ctrl(agvId,"robot_control_reloc_req",{"home":False,"x":pos[0],"y":pos[1],"angle":pos[2]})

#重定位,pos为(x,y,r)三元组 
def reloc2(agvId,pos=None,loc=None):
	if loc is not None:
		agvApi.ctrl(agvId,"robot_control_reloc_req",{"loc": loc})
	else:
		agvApi.ctrl(agvId,"robot_control_reloc_req",{"loc":'',"x":pos[0],"y":pos[1],"angle":pos[2]})

#确认定位正确 
def confirmReloc(agvId):
	data= agvApi.ctrl(agvId,"robot_control_comfirmloc_req",None)

def goCharge(agvId):
	agvApi.task(agvId, "robot_task_gocharge_req", None)

def goHome(agvId):
	agvApi.task(agvId,"robot_task_goend_req",None)

def goPoint(agvId, x, y, angle):
	data = {"x": x, "y": y, "angle": angle}
	agvApi.task(agvId, "robot_task_gopoint_req", data)


def goTarget(agvId, loc):
	data = {"id": loc}
	agvApi.task(agvId, "robot_task_gotarget_req", data)

move=goTarget

def goTargetAndDoWork(agvId, loc, operation, recognize=False,use_pgv=False):
	data = {"id": loc, 'operation': operation, 'recognize': recognize,'use_pgv':False}
	agvApi.task(agvId, "robot_task_gotarget_req", data)
 
  
def jackUpOld(agvId, loc):
	# agvApi.other(agvId, "robot_other_jack_load_req", None)
	data = {"id": loc, 'operation': 'JackLoad', 'recognize': False,'use_pgv':False}
	agvApi.task(agvId, "robot_task_gotarget_req", data)

def jackUpOldLM(agvId, loc):
	# data = {"object_path":"C:/SeerRobotics/Robokit/resources/objects/shelf/s0002.shelf"}
	data = {"object_path":"shelf/s0002.shelf"}
	agvApi.conf(agvId, "robot_config_set_shelfshape_req", data)

def goFollowUwb(agvId,uwbId=''):
	data = {"uwbId": uwbId}
	agvApi.task(agvId, "robot_task_uwb_follow_req",data)
	
#def jackDownOld(agvId):
#	agvApi.other(agvId, "robot_other_jack_unload_req", None)
#
#def jackStopOld(agvId):
#	agvApi.other(agvId, "robot_other_jack_stop_req", None)
# 
def jackUp(agvId,speed=5000,distance=60000):
	data = {"speed": speed, "distance": distance}
	agvApi.perpherial(agvId, "robot_other_robot07", data)


def jackUpStatus(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot10", None)

def jackMaxStatus(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot12", None)


def jackDown(agvId,speed=5000,distance=60000):
	data = {"speed": speed, "distance": distance}
	agvApi.perpherial(agvId, "robot_other_robot08", data)

def jackDownStatus(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot11", None)

def jackMinStatus(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot13", None)


def jackStop(agvId):
	agvApi.perpherial(agvId, "robot_other_robot09", None)

def jackDistanceStatus(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot14", None)

#-rotation start-

 
def rotationLeft(agvId,speed=30,target=90):
	data = {"speed": speed, "target": target}
	agvApi.perpherial(agvId, "robot_other_robot16", data)


def rotationRight(agvId,speed=30,target=90):
	data = {"speed": speed, "target": target}
	agvApi.perpherial(agvId, "robot_other_robot17", data)


def rotationLeftStatus(agvId, target):
	data = {"target": target}
	return agvApi.perpherial(agvId, "robot_other_robot24", data)


def rotationRightStatus(agvId, target):
	data = {"target": target}
	return agvApi.perpherial(agvId, "robot_other_robot25", data)



def rotationStop(agvId):
	agvApi.perpherial(agvId, "robot_other_robot18", None)


def rotationDistanceStatus(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot19", None)

 
def rotationReset(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot27", None)

def rotationResetStatus(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot28", None)
	
	
def rotationClear(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot32", None)
	
def rotationClearStatus(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot33", None)
	
#-rotation end-

# -pgv start-

def statusPgv(agvId):
	s = agvApi.status(agvId, "robot_status_pgv_req", None)
	log.info("agvApi.statusPgv",s)
	return s



# -pgv end-


# -audio start-

def playAudio(agvId, name, loop):
	data = {"name": name, "loop": loop}
	agvApi.other(agvId, "robot_other_speaker_req", data)

def pauseAudio(agvId):
	agvApi.other(agvId, "robot_other_pause_audio_req", None)

def resumeAudio(agvId):
	agvApi.other(agvId, "robot_other_resume_audio_req", None)

def stopAudio(agvId):
	agvApi.other(agvId, "robot_other_stop_audio_req", None)

def uploadAudio(agvId):
	agvApi.other(agvId, "robot_other_uploadaudio_req", None)

def downloadAudio(agvId,name):
	data = {"name": name}
	return agvApi.other(agvId, "robot_other_downloadaudio_req", data)

def lookupAudio(agvId):
	return agvApi.other(agvId, "robot_other_audio_list_req", None)


# -audio end-

def jackDeviceInfo(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot26", None)


def ironArmLoad(agvId):
	agvApi.perpherial(agvId, "robot_other_robot20", None)


def ironArmLoadStatus(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot22", None)


def motion(agvId, vx, vy, w):
	data = {"vx": vx, "vy": vy, "w": w}
	agvApi.ctrl(agvId, "robot_control_motion_req", data)


def stop(agvId):
	agvApi.ctrl(agvId, "robot_control_stop_req", None)


def deleteMap(agvId,mapName):
	data = {"map_name": mapName}
	agvApi.conf(agvId, "robot_config_removemap_req", data)


def downloadMap(agvId, mapName):
	data={"map_name":mapName}
	result= agvApi.conf(agvId,"robot_config_downloadmap_req",data)
	return result
 
def uploadMap(agvId,data):
	agvApi.conf(agvId,"robot_config_uploadmap_req",data)
	
def requireControl(agvId):
	return agvApi.conf(agvId, "robot_config_require_req", None)

def releaseControl(agvId):
	return agvApi.conf(agvId, "robot_config_release_req", None)

def getMapList(agvId):
	result = agvApi.status(agvId,"robot_status_map_req",None)
	return result


def switchMap(agvId, mapName):
	data = {"map_name": mapName}
	agvApi.ctrl(agvId, "robot_control_loadmap_req", data)


def clampStatus(agvId, direction):
	Data = {"direction": direction}
	return agvApi.perpherial(agvId, "robot_other_robot179", Data)


def clampOpen(agvId, direction):
	Data = {"direction": direction}
	return agvApi.perpherial(agvId, "robot_other_robot180", Data)


def clampClose(agvId, direction):
	Data = {"direction": direction}
	return agvApi.perpherial(agvId, "robot_other_robot181", Data)


def finishButtonStatus(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot182", None)




def rollerSetUnit(agvId, unitId):
	Data = {"unit": unitId}
	return agvApi.perpherial(agvId, "robot_other_robot170", Data)


def rollerBackLoad(agvId):
	return agvApi.perpherial(agvId, "robot_other_roller_back_load_req", None)


def rollerBackUnload(agvId):
	return agvApi.perpherial(agvId, "robot_other_roller_back_unload_req", None)


def rollerFrontLoad(agvId):
	return agvApi.perpherial(agvId, "robot_other_roller_front_load_req", None)


def rollerFrontUnload(agvId):
	return agvApi.perpherial(agvId, "robot_other_roller_front_unload_req", None)


def rollerLoadStatus(agvId, unitId):
	Data = {"unit": unitId}
	return agvApi.perpherial(agvId, "robot_other_robot175", Data)

def rollerUnloadStatus(agvId, unitId):
	Data = {"unit": unitId}
	return agvApi.perpherial(agvId, "robot_other_robot176", Data)

def unitStatus(agvId,unitId):
	Data = {"unit": unitId}
	return agvApi.perpherial(agvId, "robot_other_robot177", Data)

def rollerStop(agvId):
	return agvApi.perpherial(agvId, "robot_other_roller_stop_req", None)

def rollerReset(agvId):
	return agvApi.perpherial(agvId, "robot_other_roller_reset_req", None)

def rollerDeviceInfo(agvId):
	return agvApi.perpherial(agvId, "robot_other_robot178", None)



#读输入IO列表 [True,False,....]
def readIO(agvId):
	data= agvApi.status(agvId,"robot_status_io_res",None)
	for d in data["DI_valid"]:
		assert d #确保都是valid
	assert len(data["DI"]) >= 16 #确保至少16个IO
	return data["DI"]

def checkEmergency(agvId):
	data = agvApi.status(agvId, "robot_status__emergency_req", None)
	return data

def readIOs(agvId):
	data = agvApi.status(agvId, "robot_status_io_req", None)
	return data

def setDOs(agvId,data):
	agvApi.other(agvId,"robot_other_setdo_reqs",data)



#清除输出IO 
def clearIO(agvId):
	data= agvApi.status(agvId,"robot_status_io_res",None)
	for i,s in enumerate(data["DO"]):
		if not s:
			continue
		writeIO(agvId,i,False)


#设置写IO 
#id		:	number DO的id号, 从0开始 
#status	: 	boolean true为高电平,false为低电
def writeIO(agvId,id,status):
	# 从零开始
	data={"id":id,"status":status}
	agvApi.other(agvId,"robot_other_setdo_req",data)

def readStatus1(agvId):
	return agvApi.status(agvId,"robot_status_all1_req",None)
 
def setDI(agvId,id,valid):
	data = {"id":id, "valid":valid}
	return agvApi.conf(agvId,'robot_config_DI_req',data)

if __name__ == '__main__':
	import counter
	c = counter.counter()
	for i in range(10):
		move("AGV01","LM6")
	for i in range(0, 100):
		s = readStatus1("AGV01")
		c.check()






